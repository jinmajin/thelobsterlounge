<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>CODENAME LOBSTER</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <!-- Load style sheets -->
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
	<link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Pacifico' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="main.css" />
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<link type="text/css" href="css/ui-lightness/jquery-ui-1.10.0.custom.css" rel="stylesheet" />

	<!-- Load any supplemental Javascript libraries here -->
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui.custom.min.js"></script>
      
	<!--Custom JS-->
	<!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&sensor=false"></script>-->
	<script type="text/javascript" src="profile-resources.js"></script>
	<script type="text/javascript" src="infoWindowZ.js"></script>
	<script>
// This example displays a marker at the center of Australia.
// When the user clicks the marker, an info window opens.

var map;
var geocoder;
var users = [];
var genres = [];
var dates = [];
var markers = [];


function initialize() {
	geocoder = new google.maps.Geocoder();
	var mapOptions = {
		zoom: 13,
		disableDefaultUI: true
	};	
	map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

	// Try HTML5 geolocation
	if(navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(function(position) {
		  var pos = new google.maps.LatLng(position.coords.latitude,
										   position.coords.longitude);

		  var infowindow = new google.maps.InfoWindow({
			map: map,
			position: pos,
			content: 'Location found using HTML5.'
		  });

		  map.setCenter(pos);
		}, function() {
		  handleNoGeolocation(true);
		});
	} else {
		// Browser doesn't support Geolocation
		handleNoGeolocation(false);
	}
		
	var profNameToUser = {};
	var keys = Object.keys(profileResources);
	for(var i = 0; i < keys.length; i++){
		users.push(profileResources[keys[i]]);
		if(genres.indexOf(profileResources[keys[i]]["genre"]) < 0)
			genres.push(profileResources[keys[i]]["genre"]);
		profNameToUser[profileResources[keys[i]]["profileName"]] = keys[i];
	}

	for(var i = 0; i < genres.length; i++){
		$("#genres").append('<li><input type="checkbox" onchange="filter()" class="genrebox" value="'+genres[i]+'"id="checkbox_'+genres[i]+'"><label for="checkbox_'+genres[i]+'">'+genres[i]+'</label></li>');
	}
	
	function datestr(date){
		return date.month + "/" + date.day + "/" + date.year;
	}


	function createEventFor(i,j, users, perfs) {
		return function(results, status){
			if(status == "OK"){
				var loc = results[0]["geometry"]["location"];
				var datestr = perfs[j]["date"].month+"/"+perfs[j]["date"].day+"/"+perfs[j]["date"].year;

				var contentString = '<div class="content">'+
				'<h4 class="heading"><a href="profile.html?profile='+profNameToUser[users[i]["profileName"]]+'">'+users[i]["profileName"]+'</a></h4>'+
				'<div class="bodyContent">'+
				'<div class="locationAndDate">'+datestr+" -- "+perfs[j]["location"]+'</div>'+
				'<div class="details">'+perfs[j]["details"]+'</div>'+
				'</div>'+
				'</div>';
				
				var infowindow = new google.maps.InfoWindowZ({
					content: contentString,
					maxWidth: 250
				});

				var marker = new google.maps.Marker({
					position: loc,
					map: map,
					title: users[i]["profileName"],
					genre: users[i]["genre"],
					date: datestr,
					contentstr : contentString
				});

				markers.push(marker);
				
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.open(map,marker);
				});

				generateList();
			}
		}
	}
	for(var i = 0; i < users.length; i++){
		perfs = users[i]["upcomingPerformances"];
		for(var j = 0; j < perfs.length; j++){
			if(dates.indexOf(datestr(perfs[j]["date"])) < 0)
				dates.push(datestr(perfs[j]["date"]));
			geocoder.geocode({address : perfs[j]["location"] +" " + users[i]["location"].split(",")[1]}, createEventFor(i,j,users, perfs));	
		}
	}

	dates.sort();
	for(var i = 0; i < dates.length; i++){
		$("#dates").append('<li ><input type="checkbox" onchange="filter()" class="datebox" value="'+dates[i]+'" id="checkbox_'+dates[i]+'" ><label for="checkbox_'+dates[i]+'">'+dates[i]+'</label></li>');	
	}

	google.maps.event.addListener(map, 'bounds_changed', generateList);

	$("#performance_list").height($(window).height() - 100);
}
function generateList(){
	$("#performance_list").html("");
	var none = true;
	for(var i = 0; i < markers.length; i++){
		if(map.getBounds().contains(markers[i].getPosition()) && markers[i].map == map){
			$("#performance_list").append("<div class='performance' onclick='zoomInOn(markers["+i+"])' onmouseenter='setBounce("+i+")'>"+markers[i].contentstr + "</div>");
			none = false;
		}
	}
	if(none){
		$("#performance_list").append("<div class='content italic'>No events within map bounds</div>");
	}
}

function setBounce(index){
	for(var i = 0; i < markers.length; i++){
		if(i == index){
			markers[i].setAnimation(google.maps.Animation.BOUNCE);
			addStopAnimationTimeout(markers[i]);
		}
		else
			markers[i].setAnimation(null);
	}
	return false;
}

function zoomInOn(marker){
	map.setCenter(marker.position);
	map.setZoom(15);
}

function addStopAnimationTimeout(marker){
	setTimeout(function(){
		marker.setAnimation(null);
	}, 700);
}

function filter(){
	var checkedgenres = [];
	var checkeddates = [];

	$(".genrebox:checkbox:checked").each(function(){
		checkedgenres.push(this.value);
	});

	$(".datebox:checkbox:checked").each(function(){
		checkeddates.push(this.value);
	});
	for(var i = 0; i < markers.length; i++){
		if((checkedgenres.indexOf(markers[i].genre) > -1 || checkedgenres.length == 0) && (checkeddates.indexOf(markers[i].date) > -1 || checkeddates.length == 0)) {
			if(markers[i].map != map)
				markers[i].setMap(map);
		}
		else{
			markers[i].setMap(null);
		}
	}
	generateList();
}
	
function handleNoGeolocation(errorFlag) {
	var position = new google.maps.LatLng(42.360091, -71.09416);
	map.setCenter(position);
}

function showPerformanceList(){
    $('#performance_list').toggleClass('show');
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
  	<div class="left_sidebar_container">
            <div class="filters">
                <h2>Filters </h2>
                <h4>Genres</h4>
                <ul id="genres" class="hide_bullets"> 
                </ul>
                <h4>Dates</h4>
                <ul id="dates" class="hide_bullets"> 
                </ul>
            </div>
    </div>
        
    <div id="map-canvas"></div>
    <div class="right_sidebar">
            <input type="button" class="btn btn-primary" id="view_performance_list" onclick="showPerformanceList()" value="Event List"> 
            <div id="performance_list">
            </div>
        </div>
  </body>
</html>